# .github/workflows/main.yml
name: Main workflow

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  snyk-security:
    name: Run Snyk Security Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@master

      - name: Set up Snyk CLI
        uses: snyk/actions/setup@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Run Snyk Test and Export Results
        run: |
          snyk test --all-projects --json-file-output=snyk-results.json || true
          jq . snyk-results.json > snyk-results-pretty.json
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Upload to snyk dashboard
        run: snyk monitor --all-projects
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Run and upload Snyk SAST test
        continue-on-error: true
        run: |
          snyk code test --json-file-output=snyk-sast-results.json || true
          jq . snyk-sast-results.json > snyk-sast-results-pretty.json
          snyk code monitor || true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Upload Snyk Results Artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: snyk-vulnerabilities
          path: |
            snyk-results-pretty.json
            snyk-sast-results.json

      - name: Fail if high/critical found
        run: |
          # Check SCA results
          sca_high=$(jq '[.vulnerabilities[] | select(.severity=="high")] | length' snyk-results.json)
          sca_critical=$(jq '[.vulnerabilities[] | select(.severity=="critical")] | length' snyk-results.json)

          # Check SAST results
          sast_high=$(jq '[.runs[].tool.drive.rules[] | select(.properties.precision=="high")] | length' snyk-sast-results.json)
          sast_critical=$(jq [.rules[].tool.drive.rules[] | select(.properties.precision=="very-high")] | length' snyk-sast-results.json)

          echo "üîé SCA High: $sca_high"
          echo "üîé SCA Critical: $sca_critical"

          echo "üîé SAST High: $sast_high"
          echo "üîé SAST Critical: $sast_critical"

          total_high=$((sca_high+sast_high))
          total_critical=$((sca_critical+sast_critical))

          if [ "$total_high" -gt 0 ] || [ "$total_critical" -gt 0 ]; then
            echo "‚ùå High/Critical vulnerabilities found. Failing."
            exit 1
          fi
        shell: bash

  build:
    name: Build
    needs: snyk-security
    uses: ./.github/workflows/build.yml

  release:
    name: Release
    needs: snyk-security
    uses: ./.github/workflows/release.yml
