# .github/workflows/main.yml
name: Main workflow

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  snyk-security:
    name: Run Snyk Security Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@master

      - name: Set up Snyk CLI
        uses: snyk/actions/setup@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Run Snyk Test and Export Results
        run: |
          snyk test --all-projects --json-file-output=snyk-results.json || true
          jq . snyk-results.json > snyk-results-pretty.json
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Upload Snyk Results Artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: snyk-vulnerabilities
          path: snyk-results-pretty.json

      - name: Fail if high/critical found
        run: |
          high=$(jq '[.vulnerabilities[] | select(.severity=="high")] | length' snyk-results.json)
          critical=$(jq '[.vulnerabilities[] | select(.severity=="critical")] | length' snyk-results.json)

          echo "🔎 High: $high"
          echo "🔎 Critical: $critical"

          if [ "$high" -gt 0 ] || [ "$critical" -gt 0 ]; then
            echo "❌ High/Critical vulnerabilities found. Failing."
            exit 1
          fi
        shell: bash

  build:
    name: Build
    needs: snyk-security
    uses: ./.github/workflows/build.yml

  release:
    name: Release
    needs: snyk-security
    uses: ./.github/workflows/release.yml

